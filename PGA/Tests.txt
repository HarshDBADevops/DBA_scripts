-- Observation 1
-- First run of the SQL makes
-- Second run of the SQL makes in memory sort (TEST002)
-- Third run makes in memory sort again after a reboot (TEST003)
-- Hash JOIN on disk slower?? (TEST002, TEST003)

v$sql_workarea_active.WORK_AREA_SIZE: Allocated size.
v$sql_workarea_active.MAX_MEM_USED: workarea max size. It may be less than WORK_AREA_SIZE, because we may have overallocated it with manual settings.

-- Test001
SQL_ID  78adcb85jbq1f, child number 0
-------------------------------------
select sum (s.value) sumvalue from big b, small s where b.id = s.id

Plan hash value: 1355302734

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name  | Starts | E-Rows |E-Bytes|E-Temp | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  | Writes |  OMem |  1Mem | Used-Mem | Used-Tmp|
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |       |      1 |        |       |       | 71578 (100)|          |      1 |00:01:45.85 |     240K|    241K|   1209 |       |       |          |         |
|   1 |  SORT AGGREGATE     |       |      1 |      1 |    11 |       |            |          |      1 |00:01:45.85 |     240K|    241K|   1209 |       |       |          |         |
|*  2 |   HASH JOIN         |       |      1 |   2000M|    20G|  3912K| 71578   (8)| 00:00:03 |   2000M|00:01:08.22 |     240K|    241K|   1209 |    12M|  5317K|    9M (1)|      10M|
|   3 |    TABLE ACCESS FULL| SMALL |      1 |    200K|  1562K|       | 10915   (1)| 00:00:01 |    200K|00:00:00.69 |   40004 |  40000 |      0 |       |       |          |         |
|   4 |    TABLE ACCESS FULL| BIG   |      1 |   1000K|  2929K|       | 54396   (1)| 00:00:03 |   1000K|00:00:00.74 |     200K|    200K|      0 |       |       |          |         |
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ASH 
PGA	20585472	
Tmp	10485760


-- Test002
-- Repeated the pevious one
SQL_ID  78adcb85jbq1f, child number 0
-------------------------------------
select sum (s.value) sumvalue from big b, small s where b.id = s.id

Plan hash value: 1355302734

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name  | Starts | E-Rows |E-Bytes|E-Temp | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  |  OMem |  1Mem | Used-Mem | Used-Tmp|
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |       |      1 |        |       |       | 71578 (100)|          |      1 |00:01:54.46 |     240K|    240K|       |       |          |         |
|   1 |  SORT AGGREGATE     |       |      1 |      1 |    11 |       |            |          |      1 |00:01:54.46 |     240K|    240K|       |       |          |         |
|*  2 |   HASH JOIN         |       |      1 |   2000M|    20G|  3912K| 71578   (8)| 00:00:03 |   2000M|00:01:15.95 |     240K|    240K|    12M|  5317K|   16M (0)|         |
|   3 |    TABLE ACCESS FULL| SMALL |      1 |    200K|  1562K|       | 10915   (1)| 00:00:01 |    200K|00:00:00.18 |   40004 |  40000 |       |       |          |         |
|   4 |    TABLE ACCESS FULL| BIG   |      1 |   1000K|  2929K|       | 54396   (1)| 00:00:03 |   1000K|00:00:00.90 |     200K|    200K|       |       |          |         |
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ASH 
PGA	34806784	
Tmp	

-- TEST003 
-- After a reboot

SQL_ID  b96fn4w941j8r, child number 0
-------------------------------------
select /*+ TEST003*/ sum (s.value) sumvalue from big b, small s where
b.id = s.id

Plan hash value: 1355302734

-------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name  | Starts | E-Rows |E-Bytes|E-Temp | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  |  OMem |  1Mem | Used-Mem |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |       |      1 |        |       |       | 71578 (100)|          |      1 |00:01:57.16 |     240K|    240K|       |       |          |
|   1 |  SORT AGGREGATE     |       |      1 |      1 |    11 |       |            |          |      1 |00:01:57.16 |     240K|    240K|       |       |          |
|*  2 |   HASH JOIN         |       |      1 |   2000M|    20G|  3912K| 71578   (8)| 00:00:03 |   2000M|00:01:19.57 |     240K|    240K|    12M|  5317K|   17M (0)|
|   3 |    TABLE ACCESS FULL| SMALL |      1 |    200K|  1562K|       | 10915   (1)| 00:00:01 |    200K|00:00:00.19 |   40004 |  40001 |       |       |          |
|   4 |    TABLE ACCESS FULL| BIG   |      1 |   1000K|  2929K|       | 54396   (1)| 00:00:03 |   1000K|00:00:00.90 |     200K|    200K|       |       |          |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
PGA	23,224,320	
Tmp	0

SQL WORKAREA
EST OPTIM	13262848	
EST 1-pass	5444608	
LAST USED	17901568


---- TEST004
-- Not enough hash area
-- 
alter session set workarea_size_policy=manual;
alter session set hash_area_size=10000000;

select /*+ TEST004*/ sum (s.value) sumvalue
from big b, small s
where b.id = s.id;


SQL_ID  8nyyghw5k8yc8, child number 0
-------------------------------------
select /*+ TEST004*/ sum (s.value) sumvalue from big b, small s where
b.id = s.id

Plan hash value: 1355302734

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name  | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  | Writes |  OMem |  1Mem | Used-Mem | Used-Tmp|
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |       |      1 |        |       | 70676 (100)|          |      1 |00:01:40.23 |     240K|    241K|   1404 |       |       |          |         |
|   1 |  SORT AGGREGATE     |       |      1 |      1 |    11 |            |          |      1 |00:01:40.23 |     240K|    241K|   1404 |       |       |          |         |
|*  2 |   HASH JOIN         |       |      1 |   2000M|    20G| 70676   (8)| 00:00:03 |   2000M|00:01:03.01 |     240K|    241K|   1404 |    12M|  5317K| 7677K (1)|      13M|
|   3 |    TABLE ACCESS FULL| SMALL |      1 |    200K|  1562K| 10915   (1)| 00:00:01 |    200K|00:00:00.12 |   40004 |  40000 |      0 |       |       |          |         |
|   4 |    TABLE ACCESS FULL| BIG   |      1 |   1000K|  2929K| 54396   (1)| 00:00:03 |   1000K|00:00:00.70 |     200K|    200K|      0 |       |       |          |         |
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ASH:
PGA 19750912
TMP 13631488


-- TEST005
-- Lets try 12m.
-- It was enough
alter session set workarea_size_policy=manual;
alter session set hash_area_size=12000000;

select /*+ TEST005*/ sum (s.value) sumvalue
from big b, small s
where b.id = s.id;

SQL_ID  batqd2xzz7f30, child number 0
-------------------------------------
select /*+ TEST005*/ sum (s.value) sumvalue from big b, small s where
b.id = s.id

Plan hash value: 1355302734

-----------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name  | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  |  OMem |  1Mem | Used-Mem |
-----------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |       |      1 |        |       | 70676 (100)|          |      1 |00:01:50.76 |     240K|    240K|       |       |          |
|   1 |  SORT AGGREGATE     |       |      1 |      1 |    11 |            |          |      1 |00:01:50.76 |     240K|    240K|       |       |          |
|*  2 |   HASH JOIN         |       |      1 |   2000M|    20G| 70676   (8)| 00:00:03 |   2000M|00:01:13.51 |     240K|    240K|    12M|  5317K|   16M (0)|
|   3 |    TABLE ACCESS FULL| SMALL |      1 |    200K|  1562K| 10915   (1)| 00:00:01 |    200K|00:00:00.12 |   40004 |  40000 |       |       |          |
|   4 |    TABLE ACCESS FULL| BIG   |      1 |   1000K|  2929K| 54396   (1)| 00:00:03 |   1000K|00:00:00.81 |     200K|    200K|       |       |          |
-----------------------------------------------------------------------------------------------------------------------------------------------------------
ASH
PGA	32137216
Tmp	0

OPT	13262848	
ONE	5444608	
LST	17481728


-- Test006 again next day with default PGA settings

Elapsed: 00:01:51.37
08:57:24 SQL> 08:57:24 SQL> 08:57:24 SQL> 08:57:24   2  08:57:24   3
PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  b9x7jbxv0mutt, child number 0
-------------------------------------
select /*+ TEST006*/ sum (s.value) sumvalue from big b, small s where
b.id = s.id

Plan hash value: 1355302734

-------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name  | Starts | E-Rows |E-Bytes|E-Temp | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  |  OMem |  1Mem | Used-Mem |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |       |      1 |        |       |       | 71578 (100)|          |      1 |00:01:51.35 |     240K|    240K|       |       |          |
|   1 |  SORT AGGREGATE     |       |      1 |      1 |    11 |       |            |          |      1 |00:01:51.35 |     240K|    240K|       |       |          |
|*  2 |   HASH JOIN         |       |      1 |   2000M|    20G|  3912K| 71578   (8)| 00:00:03 |   2000M|00:01:14.13 |     240K|    240K|    12M|  5317K|   17M (0)|
|   3 |    TABLE ACCESS FULL| SMALL |      1 |    200K|  1562K|       | 10915   (1)| 00:00:01 |    200K|00:00:00.14 |   40004 |  40001 |       |       |          |
|   4 |    TABLE ACCESS FULL| BIG   |      1 |   1000K|  2929K|       | 54396   (1)| 00:00:03 |   1000K|00:00:01.27 |     200K|    200K|       |       |          |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------

ASH
PGA	23420928
TMP 0


-- TEST007
-- IT TOOK 7 MINUTES!!!
-- PLAN SHOWS WRONG STATS !!!
-- BUFFERS vs READS shows temp READS
Elapsed: 00:07:00.56
10:09:36 SQL> 10:09:36 SQL> 10:09:36 SQL> 10:09:36 SQL> 10:09:36 SQL> 10:09:36   2  10:09:36   3
PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  5bf1a522cwd72, child number 0
-------------------------------------
select /*+ TEST007*/ sum (s.id) sumvalue from big b, big s where b.id =
s.id

Plan hash value: 1891288466

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name | Starts | E-Rows |E-Bytes|E-Temp | Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  | Writes |  OMem |  1Mem | Used-Mem | Used-Tmp|
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |      |      1 |        |       |       |   137K(100)|          |      1 |00:00:06.21 |     400K|    402K|   2356 |       |       |          |         |
|   1 |  SORT AGGREGATE     |      |      1 |      1 |     6 |       |            |          |      1 |00:00:06.21 |     400K|    402K|   2356 |       |       |          |         |
|*  2 |   HASH JOIN         |      |      1 |     10G|    55G|    14M|   137K (20)| 00:00:06 |     10G|00:03:51.51 |     400K|    402K|   2356 |    44M|  6783K|   48M (1)|      20M|
|   3 |    TABLE ACCESS FULL| BIG  |      1 |   1000K|  2929K|       | 54396   (1)| 00:00:03 |   1000K|00:00:00.76 |     200K|    200K|      0 |       |       |          |         |
|   4 |    TABLE ACCESS FULL| BIG  |      1 |   1000K|  2929K|       | 54396   (1)| 00:00:03 |   1000K|00:00:00.82 |     200K|    200K|      0 |       |       |          |         |
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
workarea
WRK 19181568
EXP 11253760
ACT MEM USED 6180864	
MAX MEM USED 51037184 (48M in plan)
TMP	20971520 20m


-------------------------------------------------------------------
-- TEST008 is 60M better??
alter session set workarea_size_policy=manual;
alter session set hash_area_size=62914560;


select /*+ TEST008*/ sum (s.id) sumvalue
from big b, big s
where b.id = s.id;


SELECT * FROM table (
   DBMS_XPLAN.DISPLAY_CURSOR(null, null, 'ADVANCED ALLSTATS LAST -PROJECTION +ADAPTIVE -OUTLINE'))
/


Elapsed: 00:07:54.93
10:33:07 SQL> 10:33:07 SQL> 10:33:07 SQL> 10:33:07   2  10:33:07   3
PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  1wwz9f2mc2mnc, child number 0
-------------------------------------
select /*+ TEST008*/ sum (s.id) sumvalue from big b, big s where b.id =
s.id

Plan hash value: 1891288466

----------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  |  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |      |      1 |        |       |   135K(100)|          |      1 |00:07:54.88 |     400K|    400K|       |       |          |
|   1 |  SORT AGGREGATE     |      |      1 |      1 |     6 |            |          |      1 |00:07:54.88 |     400K|    400K|       |       |          |
|*  2 |   HASH JOIN         |      |      1 |     10G|    55G|   135K (20)| 00:00:06 |     10G|00:04:45.36 |     400K|    400K|    44M|  6783K|   64M (0)|
|   3 |    TABLE ACCESS FULL| BIG  |      1 |   1000K|  2929K| 54396   (1)| 00:00:03 |   1000K|00:00:00.67 |     200K|    200K|       |       |          |
|   4 |    TABLE ACCESS FULL| BIG  |      1 |   1000K|  2929K| 54396   (1)| 00:00:03 |   1000K|00:00:01.50 |     200K|    200K|       |       |          |
----------------------------------------------------------------------------------------------------------------------------------------------------------

Query Block Name / Object Alias (identified by operation id):
-------------------------------------------------------------

ASH 
PGA ALLOC 83386368 (80.4M)


-- TEST009 is 100M better??
-- NO!! It took 8 minutes
alter session set workarea_size_policy=manual;
alter session set hash_area_size=104857600;


select /*+ TEST009*/ sum (s.id) sumvalue
from big b, big s
where b.id = s.id;


SELECT * FROM table (
   DBMS_XPLAN.DISPLAY_CURSOR(null, null, 'ADVANCED ALLSTATS LAST -PROJECTION +ADAPTIVE -OUTLINE'))
/

Elapsed: 00:08:04.47
10:51:56 SQL> 10:51:56 SQL> 10:51:56 SQL> 10:51:56   2  10:51:56   3
PLAN_TABLE_OUTPUT
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SQL_ID  5m20pfjfsass6, child number 0
-------------------------------------
select /*+ TEST009*/ sum (s.id) sumvalue from big b, big s where b.id =
s.id

Plan hash value: 1891288466

----------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation           | Name | Starts | E-Rows |E-Bytes| Cost (%CPU)| E-Time   | A-Rows |   A-Time   | Buffers | Reads  |  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT    |      |      1 |        |       |   135K(100)|          |      1 |00:08:04.45 |     400K|    400K|       |       |          |
|   1 |  SORT AGGREGATE     |      |      1 |      1 |     6 |            |          |      1 |00:08:04.45 |     400K|    400K|       |       |          |
|*  2 |   HASH JOIN         |      |      1 |     10G|    55G|   135K (20)| 00:00:06 |     10G|00:04:46.74 |     400K|    400K|    44M|  6783K|   66M (0)|
|   3 |    TABLE ACCESS FULL| BIG  |      1 |   1000K|  2929K| 54396   (1)| 00:00:03 |   1000K|00:00:00.68 |     200K|    200K|       |       |          |
|   4 |    TABLE ACCESS FULL| BIG  |      1 |   1000K|  2929K| 54396   (1)| 00:00:03 |   1000K|00:00:01.48 |     200K|    200K|       |       |          |
----------------------------------------------------------------------------------------------------------------------------------------------------------

ASH
PGA ALLOCATED 76439552 (72.8)

v$sql_workarea_active
Work_area_size		108008448	
MAX MEM USED 		70233088 (66.97)